{% extends "front/base.html" %}{% block content %} {% load static %}
<!-- Compass Control Positioned at the Top of the Page with N, E, S, W -->
<div class="fixed-compass">
  <div class="compass-direction north">N</div>
  <div class="compass-direction east">E</div>
  <div class="compass-direction south">S</div>
  <div class="compass-direction west">W</div>
  <div class="compass-inner" id="compass">â€¢</div> <!-- Inner circle for rotation -->
</div>

<div id="map" style="height: 600px; position: relative;"></div>
<div id="customInfoWindow" class="custom-info-window_info" style="display: none;">
  <h3>Information</h3>
  <button id="closeInfoWindow" class="close-btn">&times;</button> 

  <p id="video_title"></p>
  <div class="video-container" id="video_container"></div>
  <div class="other-info" id="video_info"></div>
</div>


<script>
  // Get the close button and custom info window
const closeButton = document.getElementById('closeInfoWindow');
const customInfoWindow = document.getElementById('customInfoWindow');

// Add click event to close the info window
closeButton.addEventListener('click', () => {
  customInfoWindow.style.display = 'none'; // Hide the custom info window
});



  document.addEventListener("DOMContentLoaded", function () {
    const windowHeight = window.innerHeight;
    const div = document.getElementById('map');
    div.style.height = `${window.innerHeight - 100}px`;
  });

  function getPolygonCenter(coords) {
      var latSum = 0;
      var lngSum = 0;
      coords.forEach(function(coord) {
        latSum += coord.lat;
        lngSum += coord.lng;
      });
      return {
        lat: latSum / coords.length,
        lng: lngSum / coords.length
      };
    }

  function initMap() {
    
    // Coordinates for the center of the city (Gurgaon)
    var cityCenter = { lat: parseFloat('{{city_info.center_latitude}}'), lng: parseFloat('{{city_info.center_longitude}}') };
    // var gurgaonBounds = {
    //   north: 28.55476998927484,  // Northern boundary
    //   south: 28.371787123082136, // Southern boundary
    //   west: 76.94973515874823,   // Western boundary
    //   east: 77.13974236261555    // Eastern boundary
    // };
    // Create the map, centered on the city
    map_zoom=parseInt('{{city_info.map_zoom}}');
    map_min_zoom=parseInt('{{city_info.map_min_zoom}}');
    map_max_zoom=parseInt('{{city_info.map_max_zoom}}');
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: map_zoom,             // Set the initial zoom level
      minZoom: map_min_zoom,           // Minimum zoom level allowed
      maxZoom:map_max_zoom,          // Maximum zoom level allowed
      center: cityCenter,
      zoomControl: true,      // Enable zoom control buttons
      //draggable: false,      // Disable map dragging (panning)
      //gestureHandling: 'none', // Disable zoom by mouse wheel or gesture
      //disableDefaultUI: true,  // Dis

      // restriction: {
      //     latLngBounds: gurgaonBounds,  // Restrict to Gurgaon bounds
      //     strictBounds: true            // Prevent movement outside of bounds
      // }
      // restriction: {
      //     latLngBounds: { 
      //         north: 28.55476998927484,  // Northern boundary
      //         south: 28.371787123082136, // Southern boundary
      //         west: 76.94973515874823,   // Western boundary
      //         east: 77.13974236261555    // Eastern boundary
      //     },
      //     strictBounds: true
      // }
    });

    // Load the GeoJSON file
    map.data.loadGeoJson('{{city_info.boundry_file.url}}');
    var boundry_color_code='{{boundry_color_code}}';
    
    if(boundry_color_code=="NONE"){
      var strokeColor = ""
      var strokeOpacity = 0
    }else{
      var strokeColor = boundry_color_code
      var strokeOpacity = 0.8
    }
    var map_fill_color_code='{{map_fill_color_code}}';
    if(map_fill_color_code=="NONE"){
      var fillColor = ""
      var fillOpacity = 0
    }else{
      var fillColor = map_fill_color_code
      var fillOpacity = 0.35 
    }


    // Set the style for the boundaries
    map.data.setStyle({
      strokeColor: boundry_color_code,  // Outline color (red)
      strokeOpacity: strokeOpacity,      // Line opacity
      strokeWeight: 2,         // Line thickness
      fillColor: fillColor,    // Fill color inside boundary
      fillOpacity: fillOpacity       // Fill opacity
    });

    // Add event listener to the GeoJSON data layer (if you need to handle it separately)
    map.data.addListener('click', function (event) {
      var clickedLat = event.latLng.lat();
      var clickedLng = event.latLng.lng();
      console.log("GeoJSON clicked at:", { lat: clickedLat, lng: clickedLng });
      //document.getElementById("customInfoWindow").style.display = "none";
    });

    var polygonsData = {{ zones_with_boundaries| safe}}

  // Loop through each polygon data and create a polygon
  polygonsData.forEach((polygonData, index) => {
    var fillOpacity = polygonData.color ? 0.35 : 0;

    var polygon = new google.maps.Polygon({
      paths: polygonData.coords,
      strokeColor: polygonData.color,
      strokeOpacity: 0,
      strokeWeight: 2,
      fillColor: polygonData.color,
      fillOpacity: fillOpacity,
      clickable: true,
    });
    // Display the polygon on the map
    polygon.setMap(map);

    // Create a dotted boundary using a polyline
    var dottedLine = new google.maps.Polyline({
        path: polygonData.coords, // Same path as the polygon
        strokeColor: polygonData.color,
        strokeOpacity: 0.7,
        strokeWeight: 1,
        icons: [
          {
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 1, // Size of the dots
            },
            offset: "0",
            repeat: "5px" // Spacing between dots
          }
        ]
      });

      // Add the polyline to the map
      dottedLine.setMap(map);


      
    var polygonCenter = getPolygonCenter(polygonData.coords);
    var name_color_code=polygonData.name_color_code?polygonData.name_color_code:"#000000";
    var centerMarker = new google.maps.Marker({
      position: polygonCenter,
      map: map,
      title: polygonData.info,  // This displays the zone name on hover
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 0, // Hide the default marker icon
      },
      label: {
          text:polygonData.info, // Replace with your label text
          color: name_color_code, // Label text color
          fontSize: "20px", // Adjust the font size
          fontWeight: "bold",
      },
    });

    map.addListener("zoom_changed", () => {
        const currentZoom = map.getZoom(); // Get the current zoom level
        console.log(currentZoom);
        if (currentZoom <= 12) {
          centerMarker.setVisible(true); // Show marker at zoom level 15 or above
          polygon.setOptions({
            fillColor: polygonData.color,
            fillOpacity: fillOpacity,
          });
        } else {
          centerMarker.setVisible(false); // Hide marker at zoom level below 15
          polygon.setOptions({
            fillOpacity: 0,
          });
        }
    });
    

    // Add a click event to each polygon
    // google.maps.event.addListener(polygon, 'click', function (event) {
    //   // Open an InfoWindow or perform any other action here
    //   var infoWindow = new google.maps.InfoWindow({
    //     content: `<h3>${polygonData.info}</h3>`,
    //     position: event.latLng
    //   });
    //   infoWindow.open(map);
    // });
  });


  // {%if zone_list %}
  //       {% for zone_data in zone_list %}


  var additionalMarkers = {{ markers| safe }};

  // Add each additional marker with a click event
  additionalMarkers.forEach(function (markerData) {
    var additionalMarker = new google.maps.Marker({
      position: { lat: markerData.lat, lng: markerData.lng },
      map: map,
      title: markerData.label,

      //label: markerData.label,
      icon: {
        url: markerData.icon, // URL to the custom icon image
        scaledSize: new google.maps.Size(25, 25), // Scale the icon to desired size
        origin: new google.maps.Point(0, 0), // Origin point of the icon
        anchor: new google.maps.Point(15, 15) // Anchor point of the icon (centered)
      }
    });

    var infoContentAdm = `
      <div class="custom-info-window">
        <h3>${markerData.label}</h3>
        <p>${markerData.description}</p>
        <div><strong>{{ zone_data.zone_name }}</strong><br>Marker ${markerData.label}</div>
      </div>
    `;

    var centerInfoWindowAdm = new google.maps.InfoWindow({
      content: infoContentAdm
    });

    additionalMarker.addListener('click', function () {
      centerInfoWindowAdm.open(map, additionalMarker);
    });

  });

  var paths = {{ drone_video_paths| safe }}

  // Loop through each path in the array
  paths.forEach((pathData, index) => {
    var pathPolyline = new google.maps.Polyline({
      path: pathData.coordinates,
      strokeColor: pathData.color,
      strokeOpacity: 0,
      strokeWeight: 5,
      icons: [
        {
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 3,
            fillColor: pathData.color,
            fillOpacity: 1,
            strokeWeight: 0,
          },
          offset: "0",
          repeat: "7px",
        },
      ],
      zIndex: 2099,
    });

    // Display the polyline on the map
    pathPolyline.setMap(map);

    // Add mouseover event for each polyline
    google.maps.event.addListener(pathPolyline, 'mouseover', function (event) {
      // Display custom information in the info window or another HTML element
      document.getElementById("customInfoWindow").style.display = "block";
      //document.getElementById("customInfoWindow").innerText = pathData.info;
      document.getElementById("video_container").innerHTML = pathData.html_data;
      document.getElementById("video_info").innerHTML = pathData.info;
      document.getElementById("video_title").innerHTML = pathData.title;
    });
    
    // Add mouseout event to hide the info window when the mouse leaves the polyline
    google.maps.event.addListener(pathPolyline, 'mouseout', function () {
      //document.getElementById("customInfoWindow").style.display = "none";
    });
  });
 
  // Optional: Add click event to the polygon to show more info
  // polygon.addListener('click', function (event) {
  //   alert("Zone: {{ zone_data.zone_name }} clicked!");
  // });

  // {% endfor %}
  // {% endif %}



    // Optional: Add event listeners, e.g., for clicks or hovers
    // map.data.addListener('click', function (event) {
    //   document.getElementById("customInfoWindow").style.display = "none";
    // });

    
    


  }

  function openInfoWindow(id, type) {
    document.getElementById("customInfoWindow").style.display = "block";
  }
</script>



{% endblock %}